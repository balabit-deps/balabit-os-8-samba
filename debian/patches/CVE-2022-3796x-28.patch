From 590228fd72f66412a8188b3b09d2d71e91b0d568 Mon Sep 17 00:00:00 2001
From: Joseph Sutton <josephsutton@catalyst.net.nz>
Date: Fri, 25 Nov 2022 11:48:41 +1300
Subject: [PATCH] CVE-2022-37966 auth/credentials: Allow specifying password to
 cli_credentials_get_aes256_key()

BUG: https://bugzilla.samba.org/show_bug.cgi?id=15237

Signed-off-by: Joseph Sutton <josephsutton@catalyst.net.nz>
Reviewed-by: Stefan Metzmacher <metze@samba.org>

[This is 4.15 only]
---
 auth/credentials/credentials.h      | 1 +
 auth/credentials/credentials_krb5.c | 7 +------
 2 files changed, 2 insertions(+), 6 deletions(-)

--- a/auth/credentials/credentials.h
+++ b/auth/credentials/credentials.h
@@ -301,6 +301,7 @@ NTSTATUS netlogon_creds_session_encrypt(
 int cli_credentials_get_aes256_key(struct cli_credentials *cred,
 				   TALLOC_CTX *mem_ctx,
 				   struct loadparm_context *lp_ctx,
+				   const char *password,
 				   const char *salt,
 				   DATA_BLOB *aes_256);
 
--- a/auth/credentials/credentials_krb5.c
+++ b/auth/credentials/credentials_krb5.c
@@ -1459,13 +1459,13 @@ _PUBLIC_ void cli_credentials_set_target
 _PUBLIC_ int cli_credentials_get_aes256_key(struct cli_credentials *cred,
 					    TALLOC_CTX *mem_ctx,
 					    struct loadparm_context *lp_ctx,
+					    const char *password,
 					    const char *salt,
 					    DATA_BLOB *aes_256)
 {
 	struct smb_krb5_context *smb_krb5_context = NULL;
 	krb5_error_code krb5_ret;
 	int ret;
-	const char *password = NULL;
 	krb5_data cleartext_data;
 	krb5_data salt_data;
 	krb5_keyblock key;
@@ -1475,11 +1475,6 @@ _PUBLIC_ int cli_credentials_get_aes256_
 		return EINVAL;
 	}
 
-	password = cli_credentials_get_password(cred);
-	if (password == NULL) {
-		return EINVAL;
-	}
-
 	cleartext_data.data = discard_const_p(char, password);
 	cleartext_data.length = strlen(password);
 
